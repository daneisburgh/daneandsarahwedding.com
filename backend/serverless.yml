service: ${env:APP_NAME}

plugins:
  - serverless-domain-manager
  - serverless-aws-static-file-handler/plugins/BinaryMediaTypes
  - serverless-offline

custom:
  customDomain:
    domainName: ${env:DOMAIN_NAME}
    certificateName: ${env:APP_NAME}.com
    createRoute53Record: true
  apiGateway:
    binaryMediaTypes:
      - "*/*"

provider:
  name: aws
  stage: ${env:NODE_ENV}
  runtime: nodejs12.x
  timeout: 10
  logRetentionInDays: 30
  usagePlan:
    quota:
      limit: 1000
      period: DAY
    throttle:
      rateLimit: 100
      burstLimit: 1000
  environment:
    APP_NAME: ${env:APP_NAME}
    NODE_ENV: ${env:NODE_ENV}
    DOMAIN_NAME: ${env:DOMAIN_NAME}
    API_KEY: ${env:API_KEY}
    API_URL: ${env:API_URL}
    CLIENT_URL: ${env:CLIENT_URL}
    DB_HOST: ${env:DB_HOST}
    DB_USERNAME: ${env:DB_USERNAME}
    DB_PASSWORD: ${env:DB_PASSWORD}
    SMTP_USERNAME: ${env:SMTP_USERNAME}
    SMTP_PASSWORD: ${env:SMTP_PASSWORD}

functions:
  public:
    handler: build/public/index.default
    events:
      - http:
          path: /
          method: GET
          cors: true
      - http:
          path: /{filePath+}
          method: GET
          cors: true
  api-health-check:
    handler: build/api/routes/health-check.default
    events:
      - http:
          path: /api/health-check
          method: GET
          cors: true
  api-login:
    handler: build/api/routes/login.default
    events:
      - http:
          path: /api/login
          method: POST
          cors: true
  api-user-change-email:
    handler: build/api/routes/user-change-email.default
    events:
      - http:
          path: /api/user-change-email
          method: POST
          cors: true
  api-user-password-email:
    handler: build/api/routes/user-password-email.default
    events:
      - http:
          path: /api/user-password-email
          method: POST
          cors: true
  api-user-verify-email:
    handler: build/api/routes/user-verify-email.default
    events:
      - http:
          path: /api/user-verify-email
          method: POST
          cors: true
  api-user-profile-update:
    handler: build/api/routes/user-profile-update.default
    events:
      - http:
          path: /api/user-profile-update
          method: POST
          cors: true
